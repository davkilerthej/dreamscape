<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Login</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
  <style>
    /* (kept your style but trimmed in this snippet for brevity) */
    body { font-family: 'Poppins', sans-serif; margin:0; padding:0; background: linear-gradient(120deg,#1a233a,#4a5673); color:#fff; min-height:100vh; display:flex; flex-direction:column; }
    nav{ /* ... keep your nav styling ... */ }
    .login-container{ background: linear-gradient(180deg,#122030,#0b1623); padding:24px; border-radius:12px; width:100%; max-width:320px; box-shadow:0 6px 24px rgba(0,0,0,0.6); box-sizing:border-box; margin:auto; }
    .login-container input, .login-container button{ width:100%; padding:10px; margin-top:8px; border-radius:8px; border:1px solid rgba(255,255,255,0.08); background:transparent; color:#fff; font-size:1em; }
    .login-container button{ background:#14a248; border:none; font-weight:600; cursor:pointer; }
    .login-container button:disabled{ background:#666; cursor:not-allowed; }
    .login-container .msg{ margin-top:8px; min-height:20px; color:#ffcccb; font-size:0.9em; }
    .login-container .msg.success{ color:#7CFC00; }
    /* keep rest of your CSS in styles.css or inline as before */
  </style>
</head>
<body>
  <div class="menu-overlay"></div>
  <nav>
    <!-- keep your nav markup -->
    <div class="hamburger"><span></span><span></span><span></span></div>
    <div class="nav-menu">
      <a href="index">Home</a>
      <a href="about">About</a>
      <a href="contact">Contact</a>
      <a href="news">News</a>
      <a href="shop">Shop</a>
      <a href="inventory">Inventory</a>
      <div class="mobile-auth-links">
        <a href="register" class="auth-btn register-btn">Register</a>
        <a href="login" class="auth-btn login-btn">Login</a>
      </div>
    </div>
    <div class="desktop-auth-links">
      <a href="register" class="auth-btn register-btn">Register</a>
      <a href="login" class="auth-btn login-btn">Login</a>
    </div>
  </nav>

  <main>
    <div class="login-container">
      <h2>Dreamscape Login</h2>
      <small>Use the username & password you registered in Minecraft.</small>
      <input id="username" placeholder="Username" autocomplete="username" />
      <input id="password" placeholder="Password" type="password" autocomplete="current-password" />
      <button id="loginBtn">Log In</button>
      <div class="msg" id="msg"></div>
      <div class="register-link">Don't have an account? <a href="register">Register here</a></div>
    </div>
  </main>

  <footer>
    <!-- keep your footer markup -->
  </footer>

  <!-- SCRIPTS: run after DOM is ready -->
  <script>
    // hamburger/menu behavior (your original)
    document.addEventListener('DOMContentLoaded', () => {
      const hamburger = document.querySelector('.hamburger');
      const navMenu = document.querySelector('.nav-menu');
      const body = document.body;
      const overlay = document.querySelector('.menu-overlay');
      if (hamburger && navMenu) {
        hamburger.addEventListener('click', () => {
          navMenu.classList.toggle('active');
          hamburger.classList.toggle('active');
          body.classList.toggle('menu-open');
        });
      }
      if (overlay) {
        overlay.addEventListener('click', () => {
          navMenu.classList.remove('active');
          hamburger.classList.remove('active');
          body.classList.remove('menu-open');
        });
      }
    });
  </script>

  <script>
  // LOGIN logic (runs after DOMContentLoaded)
  document.addEventListener('DOMContentLoaded', () => {
    const API = "https://ytjlknmtfwlhqcgszxid.supabase.co/functions/v1/login-web"; // update if different
    const ME_API = "https://ytjlknmtfwlhqcgszxid.supabase.co/functions/v1/me";

    const loginBtn = document.getElementById('loginBtn');
    const msgEl = document.getElementById('msg');
    const usernameInput = document.getElementById('username');
    const passwordInput = document.getElementById('password');

    function showMsg(text, success = false) {
      msgEl.textContent = text;
      msgEl.classList.toggle('success', success);
    }

    async function getMe() {
      const token = localStorage.getItem('ds_token');
      if (!token) return null;
      try {
        const r = await fetch(ME_API, {
          method: 'GET',
          headers: { 'Authorization': 'Bearer ' + token }
        });
        if (!r.ok) return null;
        return await r.json();
      } catch (e) {
        console.error('getMe error', e);
        return null;
      }
    }

    // if already logged in, redirect to dashboard
    (async () => {
      const user = await getMe();
      if (user && user.ok) {
        showMsg("Already logged in as " + user.user.username, true);
        setTimeout(() => { window.location.href = "/dashboard.html"; }, 900);
      }
    })();

    loginBtn.addEventListener('click', async (ev) => {
      ev.preventDefault();
      const u = usernameInput.value.trim();
      const p = passwordInput.value;
      if (!u || !p) {
        showMsg('Enter username and password', false);
        return;
      }

      loginBtn.disabled = true;
      loginBtn.textContent = 'Logging in...';
      showMsg('Logging in...');

      try {
        const res = await fetch(API, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username: u, password: p })
        });
        const j = await res.json();
        if (!res.ok) {
          showMsg(j.error || ('Login failed (HTTP ' + res.status + ')'), false);
          loginBtn.disabled = false;
          loginBtn.textContent = 'Log In';
          return;
        }
        localStorage.setItem('ds_token', j.token);
        showMsg('Logged in! Welcome ' + (j.username || u), true);
        loginBtn.textContent = 'Success!';
        setTimeout(() => window.location.href = '/dashboard.html', 700);
      } catch (err) {
        console.error('login error', err);
        showMsg('Network error: ' + String(err), false);
        loginBtn.disabled = false;
        loginBtn.textContent = 'Log In';
      }
    });
  });
  </script>
</body>
</html>
