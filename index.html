<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dreamscape</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
  <style>
    /* small inline tweaks so you get the green counter right away */
    #server-count { color: #7CFC00; font-size: 1.6rem; font-weight:700; }
    .auth-btn { cursor:pointer; padding:6px 12px; border-radius:10px; border:1px solid rgba(255,255,255,0.08); background:transparent; color:white; text-decoration:none; margin-left:8px; }
  </style>
</head>
<body>
  <nav>
    <div class="hamburger"><span></span><span></span><span></span></div>
    <div class="nav-menu">
      <a href="index.html">Home</a>
      <a href="about.html">About</a>
      <a href="contact.html">Contact</a>
      <a href="news.html">News</a>
      <a href="shop.html">Shop</a>
      <a href="inventory.html">Inventory</a>
    </div>

    <div id="auth-area" style="display:flex;align-items:center;">
      <!-- JS will populate -->
      <a id="login-btn" class="auth-btn">Login / Register</a>
      <a id="logout-btn" class="auth-btn" style="display:none;">Logout</a>
      <span id="welcome" style="margin-left:8px;"></span>
    </div>
  </nav>

  <main>
    <h2>Welcome to Dreamscape</h2>
    <p>Dreamscape is the ultimate Minecraft server experience...</p>

    <div id="gamemodes">
      <!-- your existing gamemode cards -->
    </div>

    <div style="margin-top:18px; text-align:center;">
      <strong>Players online: <span id="server-count">—</span></strong>
      <div id="server-updated" style="font-size:0.9rem; opacity:0.85; margin-top:6px;">Last: —</div>
    </div>
  </main>

  <!-- Simple modal for email login -->
  <div id="login-modal" style="display:none; position:fixed; left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.6);align-items:center;justify-content:center;">
    <div style="background:#172034;padding:20px;border-radius:10px;color:white;min-width:300px;">
      <h3>Login / Register</h3>
      <p>Enter your email — we'll send a magic link to sign in.</p>
      <input id="login-email" type="email" placeholder="you@example.com" style="width:100%; padding:8px; border-radius:6px; border:none; margin-bottom:8px;">
      <div style="display:flex; justify-content:flex-end;">
        <button id="login-send" style="padding:8px 12px;border-radius:8px;">Send Link</button>
        <button id="login-cancel" style="margin-left:8px;padding:8px 12px;border-radius:8px;background:#333;color:white;border:none;">Cancel</button>
      </div>
      <div id="login-feedback" style="margin-top:8px;font-size:0.9rem;opacity:0.9;"></div>
    </div>
  </div>

  <!-- Supabase + app script -->
  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    // ----- REPLACE WITH YOUR VALUES -----
    const SUPABASE_URL = 'https://ytjlknmtfwlhqcgszxid.supabase.co';
    const SUPABASE_ANON_KEY = '<YOUR_ANON_KEY_HERE>';
    const SERVER_ID = 'dreamscape-main';
    // ------------------------------------

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // UI elems
    const loginBtn = document.getElementById('login-btn');
    const logoutBtn = document.getElementById('logout-btn');
    const welcome = document.getElementById('welcome');
    const loginModal = document.getElementById('login-modal');
    const loginCancel = document.getElementById('login-cancel');
    const loginSend = document.getElementById('login-send');
    const loginEmail = document.getElementById('login-email');
    const loginFeedback = document.getElementById('login-feedback');
    const serverCountEl = document.getElementById('server-count');
    const serverUpdatedEl = document.getElementById('server-updated');

    // Show/hide auth UI
    function showLoggedOutUI() {
      loginBtn.style.display = 'inline-block';
      logoutBtn.style.display = 'none';
      welcome.textContent = '';
    }
    function showLoggedInUI(user) {
      loginBtn.style.display = 'none';
      logoutBtn.style.display = 'inline-block';
      const displayName = user.user_metadata?.full_name || user.email || user.id;
      welcome.textContent = `Welcome, ${displayName}`;
    }

    // Auth functions
    loginBtn.addEventListener('click', () => loginModal.style.display = 'flex');
    loginCancel.addEventListener('click', () => {
      loginModal.style.display = 'none';
      loginFeedback.textContent = '';
    });

    loginSend.addEventListener('click', async () => {
      const email = loginEmail.value && loginEmail.value.trim();
      if (!email) { loginFeedback.textContent = 'Enter a valid email.'; return; }
      loginFeedback.textContent = 'Sending link…';

      // magic link sign-in
      const { error } = await supabase.auth.signInWithOtp({ email });
      if (error) {
        loginFeedback.textContent = 'Error: ' + error.message;
      } else {
        loginFeedback.textContent = 'Check your inbox for the magic link.';
      }
    });

    logoutBtn.addEventListener('click', async () => {
      await supabase.auth.signOut();
      // UI will update via onAuthStateChange
    });

    // React to auth changes
    supabase.auth.onAuthStateChange((event, session) => {
      // session may be null (signed out)
      (async () => {
        if (session?.user) {
          // fetch user object to display metadata
          const user = session.user;
          showLoggedInUI(user);
        } else {
          showLoggedOutUI();
        }
      })();
    });

    // initialize auth state on page load
    (async () => {
      const { data } = await supabase.auth.getSession();
      if (data?.session?.user) {
        showLoggedInUI(data.session.user);
      } else {
        showLoggedOutUI();
      }
    })();

    // --- Player count fetching & realtime ---
    async function updateDOM(count, last) {
      serverCountEl.textContent = String(count ?? 0);
      serverCountEl.style.color = '#7CFC00';
      serverUpdatedEl.textContent = 'Last: ' + (last ? new Date(last).toLocaleString() : '—');
    }

    async function loadCount() {
      try {
        const { data, error } = await supabase
          .from('server_stats')
          .select('online_count, last_updated')
          .eq('server_id', SERVER_ID)
          .limit(1)
          .single();
        if (error) {
          console.debug('supabase select error', error);
          return;
        }
        if (data) updateDOM(data.online_count, data.last_updated);
      } catch (e) {
        console.error('loadCount failed', e);
      }
    }

    function subscribe() {
      const channel = supabase.channel('public:server_stats')
        .on('postgres_changes',
            { event: 'UPDATE', schema: 'public', table: 'server_stats', filter: `server_id=eq.${SERVER_ID}` },
            (payload) => {
              const row = payload.new ?? payload;
              updateDOM(row.online_count, row.last_updated);
            })
        .subscribe((status) => {
          console.debug('Realtime status', status);
        });

      // keep ref
      window.__supabase_server_channel = channel;
    }

    // init
    loadCount();
    setInterval(loadCount, 15000);
    subscribe();
  </script>
</body>
</html>
